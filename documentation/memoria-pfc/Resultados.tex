\chapter{Resultados}
\label{ch:resultados}

% En esta sección se describirá la aplicación del método de trabajo presentado en el capítulo 4 en este caso concreto, mostrando los elementos (modelos, diagramas, especificaciones, etc.) más importantes.

% Explicación del desarrollo de la herramienta
% Casos de uso más importantes
% Diagramas más importantes
% Arquitectura/Estructura de la herramienta
% Medidas
% Niveles (factoría y proyecto)
% Seguridad con Spring Security
% ...

\section{Control de Acceso Basado en Grupos (GBAC) mediante Spring Security}

Las funcionalidades relativas a autenticación, seguridad y control de acceso son muy comunes en aplicaciones web. Gracias a ellas es posible establecer políticas que indiquen quienes tienen la capacidad de acceder a un conjunto determinado de recursos o información. Por tanto, para no reinventar la rueda en cada ocasión que es necesario implementar características de esta índole, se recomienda hacer uso de frameworks especialmente diseñados para estos propósitos.

Spring Security (\textit{http://static.springsource.org/spring-security/site/}) es un framework potente y configurable mediante ficheros XML, que proporciona métodos de autenticación y control de acceso en aplicaciones basadas en Spring. Su publicación bajo una licencia Apache 2.0 y su uso extendido por agencias gubernamentales, aplicaciones militares y bancos, hacen de él una alternativa muy competente y confiable.

Antes de proceder con la configuración de Spring Security, es necesario tomar dos decisiones de diseño muy importantes: qué política de acceso se desea implementar y cuál será el método de conexión con la base de datos.

La \textbf{política de acceso} define qué usuarios o sistemas pueden acceder a determinados recursos o información. En este caso de estudio se han contemplado las dos posibilidades más comunes en aplicaciones web: control de acceso basado en roles y control de acceso basado en grupos.
\begin{itemize}
	\item Control de Acceso basado en \textbf{roles} (en inglés, \textit{\textbf{Role}-based access control} o \textbf{R}BAC). Consiste en una política de seguridad en la que el sistema otorga privilegios al usuario en función de su rol. Un usuario puede tener uno o varios roles.
	\item Control de Acceso basado en \textbf{grupos} (en inglés, \textit{\textbf{Group}-based access control} o \textbf{G}BAC). Este modelo extiende al RBAC y ofrece más flexibilidad para modelar políticas de acceso más complejas y exigentes. En este caso, los privilegios se otorgan al usuario en función de los grupos a los que pertenezca. Un usuario puede pertenecer a uno o varios grupos, y un grupo puede tener asignados uno o varios roles.
\end{itemize}

Se ha seleccionado la segunda opción dada la gran flexibilidad y opciones de extensibilidad y mantenibilidad que proporciona para la adición de futuros requisitos de usuario. En (Fig. \ref{fig:spring-security-database-schema}) se aprecia un esquema minimalista de la base de datos que es necesario diseñar para implementar un GBAC mediante Spring Security. Si se desea añadir información adicional, es posible añadir nuevas columnas a las tablas del esquema propuesto.
\begin{itemize}
	\item \textbf{Tabla \textit{users}}. Contiene la información relativa a los usuarios de la aplicación web. Spring Security exige que los usuarios tengan un nombre de usuario, una contraseña y una serie de atributos que indiquen si la cuenta está habilitada, caducada, bloqueada o si las credenciales han caducado. Esto es debido porque la clase Java perteneciente a la entidad \textit{Usuario} deberá implementar un interfaz de Spring denominado \textit{UserDetails} (Fig. \ref{fig:spring-security-class-diagram}).
	\item \textbf{Tabla \textit{groups}}. Contiene el nombre y la descripción de los grupos de usuarios que se desean crear. Se establecerá una relación \textit{muchos-a-muchos} entre los usuarios y los grupos gracias a la tabla \textit{users\_groups}.
	\item \textbf{Tabla \textit{roles}}. Contiene el nombre y la descripción de los roles disponibles en el sistema. En Spring Security, por defecto aunque configurable, el nombre de los roles debe comenzar con el prefijo ``\textit{ROLE\_}''. Se establecerá una relación \textit{muchos-a-muchos} entre los grupos y los roles gracias a la tabla \textit{groups\_roles}.
\end{itemize}

\imagen{Cap5//spring-security-database-schema}{0.48}{Esquema minimalista de base de datos para configurar un GBAC mediante Spring Security}{fig:spring-security-database-schema}

El método de conexión con la base de datos no afecta a las funcionalidades del sistema, pero sí afecta a la implementación del mismo. En este aspecto se han contemplado dos posibilidades: JDBC (Java Database Connectivity) e Hibernate. Para esta característica, al igual que para el resto de la persistencia de la aplicación web, se ha elegido emplear Hibernate dada su eficiencia, gran integración con Spring, y facilidad de configuración entre las tablas de una base de datos relacional y una jerarquía de objetos Java.

En (Fig. \ref{fig:spring-security-class-diagram}) se muestra un diagrama de clases que representa las clases e interfaces que intervienen en la implementación de un GBAC mediante Spring, Spring Security e Hibernate. Los espacios de nombre relativos a dichas tecnologías se representan en la parte superior de la imagen como paquetes y subpaquetes UML, donde se han representado las interfaces y clases relevantes para la resolución de este problema. En la parte inferior de la imagen se representa el conocimiento que es necesario implementar en la aplicación:
\begin{itemize}
	\item \textbf{Clase User} (Véase Anexo \ref{subsec:user}). Implementa el interfaz UserDetails de Spring Security. Este interfaz obliga que la clase User implemente los métodos que define y, por tanto, se añadan sus respectivos atributos (username, password, enabled, accountNonExpired, credentialsExpired y accountNonLocked). Además, presenta una asociación unidireccional múltiple con la clase Group que será implementada mediante un \textit{Set} de Java. Por último, se mapea mediante JPA (Java Persistence API) con la tabla \textit{users} del esquema de bases de datos descrito en (Fig. \ref{fig:spring-security-database-schema}). Cabe destacar la implementación del método \textit{getAuthorities}, que devuelve todos las autoridades, encapsuladas en un array de tipo GrantedAuthority -definido por Spring Security-, de cada uno de los grupos a los que pertenece el usuario.
	
	\item \textbf{Clase Group} (Véase Anexo \ref{subsec:group}). De un modo similar a la clase User, la clase Group presenta una asociación unidireccional múltiple con la clase Role que será implementada mediante un \textit{Set} de Java y se mapea mediante JPA con la tabla \textit{groups}. Una vez más, en este caso cabe destacar la implementación del método \textit{getAuthorities}.
	
	\item \textbf{Clase Role} (Véase Anexo \ref{subsec:role}). En este caso no se presenta ningún tipo de asociación, por lo que esta en esta clase sólo será necesario implementar el \textit{interface} GrantedAuthority de Spring Security y realizar su correspondiente mapeo con la tabla \textit{roles} mediante JPA.
	
	\item \textbf{Clase CustomUserDetailsService} (Véase Anexo \ref{subsec:customuserdetailsservice}). Esta clase implementa el \textit{interface} UserDetailsService y su responsabilidad se basa en establecer el mecanismo de búsqueda y materialización de los datos del usuario. Este proceso se realiza mediante un DAO (Data Access Object) que hereda las funcionalidades proporcionadas por Spring mediante la clase \textbf{HibernateDaoSupport}.
\end{itemize}

\imagen{Cap5//spring-security-class-diagram}{2.0}{Diagrama de clases para implementar un GBAC mediante Spring, Spring Security e Hibernate}{fig:spring-security-class-diagram}

A continuación, es necesario configurar Spring Security mediante un fichero de configuración. Se trata de un fichero XML que por convenio suele llamarse \textit{applicationContext-security.xml} (Véase Anexo \ref{subsec:applicationcontext}). Dada la gran cantidad de parámetros que se pueden incluir en este fichero, se recomienda consultar su manual de referencia (\textit{http://static.springsource.org/spring-security/site/reference.html}) para profundizar en el tema y realizar una configuración precisa. En este caso de estudio se destacan los siguientes nodos y \textit{beans}:
\begin{itemize}
	\item {http}.
	\item {authentication-provider}.
	\item {userDetailsService}.
	\item {dataSource}.
	\item {sessionFactory}.
	\item {hibernateTemplate}.
\end{itemize}